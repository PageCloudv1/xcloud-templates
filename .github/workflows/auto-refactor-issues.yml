name: 'ğŸ”„ Auto-Refactor Issues by rootkit-original'

on:
  issues:
    types: [opened]

concurrency:
  group: '${{ github.workflow }}-refactor-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  auto-refactor:
    name: 'ğŸ”„ Refatorar e Auto-Assinar Issue'
    runs-on: 'ubuntu-latest'
    timeout-minutes: 10

    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'read'

    steps:
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        uses: 'actions/create-github-app-token@v1'
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_PRIVATE_KEY }}
          owner: 'PageCloudv1'
          repositories: 'xcloud-bot'

      - name: 'ï¿½ Aplicar Auto-AtribuiÃ§Ã£o Simples'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            // Auto-assinar para rootkit-original
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['rootkit-original']
            });

            // Adicionar label de auto-refatoraÃ§Ã£o
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ğŸ¤– auto-refactored', 'ğŸ‘¤ rootkit-original']
            });

            core.info('Issue auto-assinada para rootkit-original');

      - name: 'ğŸ’¬ Postar ComentÃ¡rio de ConfirmaÃ§Ã£o'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            const comentario = `## ğŸ”„ Auto-AtribuiÃ§Ã£o Aplicada

            ğŸ¤– **xCloud Bot** identificou que esta issue foi criada por @rootkit-original e aplicou as seguintes aÃ§Ãµes automaticamente:

            ### âœ… **AÃ§Ãµes Realizadas**
            - **Auto-assinatura**: Issue atribuÃ­da automaticamente para vocÃª
            - **Labels aplicadas**: \`ğŸ¤– auto-refactored\` e \`ğŸ‘¤ rootkit-original\`

            ### ğŸ”„ **PrÃ³ximos Passos**
            - O sistema de refatoraÃ§Ã£o inteligente serÃ¡ implementado em breve
            - Por enquanto, a issue estÃ¡ pronta para seu desenvolvimento

            ### ğŸ¤ **AssistÃªncia do Copilot**
            
            @Copilot estÃ¡ disponÃ­vel para ajudar com esta issue! VocÃª pode:
            - Pedir sugestÃµes de implementaÃ§Ã£o
            - Solicitar anÃ¡lise de cÃ³digo
            - Obter ajuda com debugging
            - Discutir a melhor abordagem

            ---
            ğŸ”„ *Auto-atribuiÃ§Ã£o aplicada | Sistema bÃ¡sico funcionando*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comentario
            });

      - name: 'âŒ Notificar Falha na Auto-AtribuiÃ§Ã£o'
        if: failure()
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |-
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âš ï¸ Falha na Auto-AtribuiÃ§Ã£o

              ğŸ¤– **xCloud Bot** encontrou um problema ao tentar aplicar a auto-atribuiÃ§Ã£o nesta issue.

              ### ğŸ” **O que Aconteceu**
              Ocorreu um erro durante o processo de auto-atribuiÃ§Ã£o automÃ¡tica.

              ### ğŸ“‹ **AÃ§Ãµes Manuais NecessÃ¡rias**
              - Atribua a issue para si mesmo manualmente
              - Aplique as labels apropriadas

              ---
              âš ï¸ *Auto-atribuiÃ§Ã£o falhou | AÃ§Ã£o manual necessÃ¡ria*`
            });
